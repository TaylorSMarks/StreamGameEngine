<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>StreamGameEngine</title>
    <style>
        html, body {
            overflow: hidden;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }

        #renderCanvas {
            width: 100%;
            height: 100%;
            touch-action: none;
        }
    </style>

    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script>
        const models = {};
        const meshes = {};

        async function addModel(data) {
          console.log(`addModel(${JSON.stringify(data)})`);
          const name = `Model_${data.id}`;
          var newModel;
          if (data.mesh === "sphere") {
              newModel = BABYLON.MeshBuilder.CreateSphere(name);
          } else {
              newModel = new BABYLON.Mesh(name);
              if (!meshes.hasOwnProperty(data.mesh)) {
                  const response = await fetch(`/mesh/${data.mesh}`);
                  const meshData = await response.json();
                  const normals = [];
                  BABYLON.VertexData.ComputeNormals(meshData.positions, meshData.indices, normals);
                  const vertexData = new BABYLON.VertexData();
                  vertexData.positions = meshData.positions;
                  vertexData.indices = meshData.indices;
                  vertexData.normals = normals;
                  meshes[data.mesh] = vertexData;
              }
              meshes[data.mesh].applyToMesh(newModel);
          }
          models[data.id] = newModel;
          console.log(`model created with id ${data.id}`);
          newModel.position = new BABYLON.Vector3(data.x, data.y, data.z);
          newModel.material = new BABYLON.StandardMaterial(`Material_${data.id}`);
          newModel.material.diffuseColor = BABYLON.Color3.FromHexString(data.color);

          if (data.clickable) {
            newModel.actionManager = new BABYLON.ActionManager();
            newModel.actionManager.registerAction(
              new BABYLON.ExecuteCodeAction(
                BABYLON.ActionManager.OnPickTrigger,
                function() { fetch(`/clickModel/${data.id}`); }
            ));
          }
        }

        function moveModel(data) {
          console.log(`Attempting to move model with id ${data.id}`);
          const model = models[data.id];
          const fps = 30;
          const frames = fps * data.duration;
          BABYLON.Animation.CreateAndStartAnimation(`Move_Model_${data.id}`, model, 'position', fps, frames, model.position, new BABYLON.Vector3(data.x, data.y, data.z), BABYLON.Animation.ANIMATIONLOOPMODE_CONSTANT);
        }

        function removeModel(data) {
          models[data.id].dispose();
          delete models[data.id];
        }

        window.addEventListener('load', function() {
          const canvas = document.getElementById("renderCanvas");
          const engine = new BABYLON.Engine(canvas, true);
          const scene = new BABYLON.Scene(engine);

          const cameraTarget = new BABYLON.Vector3(3.5, 0, -3.5);
          const camera = new BABYLON.ArcRotateCamera("camera", -Math.PI / 2, Math.PI / 2.5, 15, cameraTarget);
          camera.attachControl(canvas, true);
          const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(1, 1, 0));

          engine.runRenderLoop(function () {
              scene.render();
          });

          // Watch for browser/canvas resize events
          window.addEventListener("resize", function () {
              engine.resize();
          });

          const eventSource = new EventSource("event-stream");
          eventSource.addEventListener("addModel",    (event) => { addModel   (JSON.parse(event.data)); });
          eventSource.addEventListener("moveModel",   (event) => { moveModel  (JSON.parse(event.data)); });
          eventSource.addEventListener("removeModel", (event) => { removeModel(JSON.parse(event.data)); });
        });
    </script>
</head>
<body>
    <canvas id="renderCanvas"></canvas>
</body>
</html>